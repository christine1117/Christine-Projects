{"cells":[{"cell_type":"markdown","metadata":{"id":"gLEQCNfkBxm6"},"source":["# ğŸ“š æ‰“é€  Stable Diffusion çš„ WebUI\n","\n","### 1. å®‰è£å¿…è¦å¥—ä»¶"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"50QsZ9LcBw5Y"},"outputs":[],"source":["!pip install diffusers transformers accelerate safetensors huggingface_hub gradio --upgrade"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"e3YMEdSZB98I"},"outputs":[],"source":["#from google.colab import userdata\n","#from huggingface_hub import login\n","\n","#hf_token = userdata.get(\"HuggingFace\")\n","#login(token=hf_token)"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"AxCcNOPBCmf2"},"outputs":[],"source":["from diffusers import StableDiffusionXLPipeline, UniPCMultistepScheduler\n","import torch\n","import gc\n","import matplotlib.pyplot as plt\n","import gradio as gr\n","import random\n","from transformers import pipeline"]},{"cell_type":"markdown","metadata":{"id":"8NhvpxxqCqps"},"source":["### 2. æŒ‡å®šä¸¦è®€å…¥æ¨¡å‹"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"yy2-xjIyCpbI"},"outputs":[],"source":["model_name = \"John6666/cyberrealistic-pony-v85-sdxl\""]},{"cell_type":"markdown","source":["æ³¨æ„æœ‰å¯èƒ½è¦åœç”¨ `use_safetensors=True`ã€‚"],"metadata":{"id":"cfsSUkxlUpsi"}},{"cell_type":"code","execution_count":null,"metadata":{"id":"c4fEdszfCyO7"},"outputs":[],"source":["pipe = StableDiffusionXLPipeline.from_pretrained(\n","    model_name,\n","    torch_dtype=torch.float16,\n","    use_safetensors=True\n",").to(\"cuda\")"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"rzzFo2qCC56V"},"outputs":[],"source":["pipe.scheduler = UniPCMultistepScheduler.from_config(pipe.scheduler.config)"]},{"cell_type":"markdown","metadata":{"id":"X4ZAPdMsC_Dq"},"source":["### 3. ç”Ÿæˆçš„å‡½å¼"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"mpPjwVKbDEKe"},"outputs":[],"source":["def generate_images(prompt, use_enhance, enhance_text, use_negative, negative_text,\n","                    use_custom_seed, custom_seed, height, width, steps, num_images, Translation_optimize):\n","\n","    height = int(height)\n","    width = int(width)\n","\n","    if height % 8 != 0 or width % 8 != 0:\n","        raise ValueError(\"é«˜åº¦å’Œå¯¬åº¦å¿…é ˆæ˜¯8çš„å€æ•¸ï¼\")\n","\n","    base_seed = int(custom_seed) if use_custom_seed else random.randint(0, 2**32 - 1)\n","    seeds = [base_seed + i for i in range(num_images)]\n","\n","    final_prompt = translate_to_en(prompt) if Translation_optimize else prompt\n","    if use_enhance and enhance_text:\n","        final_prompt += \", \" + enhance_text\n","\n","\n","\n","    # è² é¢ prompt\n","    final_negative = negative_text if use_negative else None\n","\n","    prompts = [final_prompt] * num_images\n","    negative_prompts = [final_negative] * num_images\n","    generators = [torch.Generator(\"cuda\").manual_seed(seed) for seed in seeds]\n","\n","    gc.collect()\n","    torch.cuda.empty_cache()\n","\n","    images = []\n","    for i in range(num_images):\n","        with torch.no_grad():\n","            image = pipe(\n","                prompt=prompts[i],\n","                prompt_2=None,\n","                negative_prompt=negative_prompts[i],\n","                height=height,\n","                width=width,\n","                num_inference_steps=steps,\n","                guidance_scale=7.5,\n","                generator=generators[i],\n","                added_cond_kwargs={}\n","            ).images[0]\n","            images.append(image)\n","\n","\n","    return images, f\"ä½¿ç”¨çš„ random seeds: {seeds}\", final_prompt\n"]},{"cell_type":"code","source":["from transformers import pipeline\n","\n","zh2en = pipeline(\"translation\", model=\"Helsinki-NLP/opus-mt-zh-en\")\n","\n","def translate_to_en(text):\n","    return zh2en(text, max_length=128)[0]['translation_text']\n","\n","\n","\n","\n"],"metadata":{"id":"4NS9U9LF811A"},"execution_count":null,"outputs":[]},{"cell_type":"code","source":["example_prompts = [\n","    \"woman reading in a school library\",\n","    \"girl walking in a university hallway\",\n","    \"student sitting by the window in a classroom\",\n","    \"ä¸€ä½å¥³ç”Ÿååœ¨æ•™å®¤è§’è½ç¿»ç­†è¨˜\",\n","    \"ç©¿è‘—é¢¨è¡£çš„å­¸ç”Ÿèµ°åœ¨æ ¡åœ’æ—è”­å¤§é“\"\n","]\n"],"metadata":{"id":"oyQGqKDRBxb-"},"execution_count":null,"outputs":[]},{"cell_type":"markdown","metadata":{"id":"eKiTPYpWDVln"},"source":["### 4. æ‰“é€  Gradio Web App"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"2uJnUGTXDOCN"},"outputs":[],"source":["default_enhance = \"masterpiece, ultra high quality, intricate skin details, cinematic lighting\"\n","default_negative = \"bad anatomy, blurry, disfigured, , poorly drawn hands, extra fingers, mutated hands, low quality, worst quality\"\n","with gr.Blocks(css=\".gradio-container {background-color: #FAFAFA; padding: 20px;} .gr-button {font-size: 18px; background: linear-gradient(to right, #667eea, #764ba2); color: white;}\") as demo:\n","    gr.Markdown(\"\"\"\n","    # Cyberrealistic Pony v85 äº’å‹•åœ–åƒç”Ÿæˆå™¨\n","    æ­¡è¿ä½¿ç”¨ï¼è¼¸å…¥æç¤ºè©ã€é¸æ“‡è¨­å®šï¼Œç«‹å³ç”Ÿæˆè¶…å¯«å¯¦çš„äººç‰©ä½œå“ï¼\n","    \"\"\")\n","\n","    with gr.Row():\n","        with gr.Column(scale=6):\n","            prompt = gr.Textbox(label=\"Prompt\", placeholder=\"è«‹è¼¸å…¥ä½ çš„æç¤ºè© (prompt)\", lines=3)\n","\n","            with gr.Row():\n","                example_prompt = gr.Dropdown(choices=example_prompts, label=\"ğŸŒŸ æ¨è–¦ Prompt ç¯„ä¾‹\")\n","                apply_example_btn = gr.Button(\"ğŸ“Œ å¥—ç”¨æ­¤ Prompt\")\n","\n","            with gr.Row():\n","                Translation_optimize = gr.Checkbox(label=\"ğŸŒ ä¸­æ–‡ Prompt è½‰è‹±æ–‡ (è‡ªå‹•ç¿»è­¯)\", value=False)\n","\n","\n","            with gr.Row():\n","                use_enhance = gr.Checkbox(label=\"åŠ å¼· Prompt\", value=True)\n","                enhance_text = gr.Textbox(label=\"åŠ å¼·å…§å®¹\", value=default_enhance)\n","\n","            with gr.Row():\n","                use_negative = gr.Checkbox(label=\"ä½¿ç”¨ Negative Prompt\", value=True)\n","                negative_text = gr.Textbox(label=\"Negative Prompt å…§å®¹\", value=default_negative)\n","\n","            with gr.Row():\n","                use_custom_seed = gr.Checkbox(label=\"è‡ªè¨‚ Random Seed\", value=False)\n","                custom_seed = gr.Number(label=\"æŒ‡å®š seed (é¸å¡«)\", value=42)\n","\n","            with gr.Row():\n","                height = gr.Dropdown([\"512\", \"768\", \"1024\"], label=\"é«˜åº¦ Height\", value=\"512\")\n","                width = gr.Dropdown([\"512\", \"768\", \"1024\"], label=\"å¯¬åº¦ Width\", value=\"512\")\n","\n","            with gr.Row():\n","                steps = gr.Slider(10, 50, value=20, step=5, label=\"ç”Ÿæˆæ­¥æ•¸ (Steps)\")\n","                num_images = gr.Slider(1, 5, step=1, value=1, label=\"ç”Ÿæˆå¼µæ•¸\")\n","\n","            generate_btn = gr.Button(\"ğŸš€ é–‹å§‹ç”Ÿæˆï¼\")\n","\n","        with gr.Column(scale=6):\n","            gallery = gr.Gallery(label=\"ç”Ÿæˆçµæœ\", columns=2, object_fit=\"contain\", height=\"auto\")\n","            seed_info = gr.Label(label=\"ä½¿ç”¨çš„ Random Seeds\")\n","            optimized_prompt_display = gr.Textbox(\n","                label=\"âœ¨ æœ€çµ‚è‹±æ–‡ Promptï¼ˆç¿»è­¯ + åŠ å¼·å¾Œï¼‰\",\n","                interactive=False,\n","                lines=3,\n","                visible=True\n","            )\n","    generate_btn.click(\n","    fn=generate_images,\n","    inputs=[prompt, use_enhance, enhance_text, use_negative, negative_text,\n","            use_custom_seed, custom_seed, height, width, steps, num_images, Translation_optimize],\n","    outputs=[gallery, seed_info, optimized_prompt_display]\n",")\n","\n","\n","    apply_example_btn.click(\n","        fn=lambda x: x,\n","        inputs=example_prompt,\n","        outputs=prompt\n","    )\n"]},{"cell_type":"code","execution_count":null,"metadata":{"id":"IYR6wPYHDmkn"},"outputs":[],"source":["demo.launch(share=True, debug=True)"]}],"metadata":{"accelerator":"GPU","colab":{"gpuType":"T4","private_outputs":true,"provenance":[{"file_id":"https://github.com/yenlung/AI-Demo/blob/master/%E3%80%90Demo08g%E3%80%91%E6%89%93%E9%80%A0Stable_Diffusion%E7%9A%84WebUI.ipynb","timestamp":1745920273865}]},"kernelspec":{"display_name":"Python 3","name":"python3"},"language_info":{"name":"python"}},"nbformat":4,"nbformat_minor":0}